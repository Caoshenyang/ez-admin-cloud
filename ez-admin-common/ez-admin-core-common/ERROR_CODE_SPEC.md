# 错误码规范文档

## 1. 概述

本文档定义了 ez-admin-cloud 微服务项目的统一错误码规范。采用**分段式错误码**设计，确保分布式系统中错误码的唯一性、可读性和可维护性。

## 2. 错误码结构

### 2.1 格式定义

```
┌─────────────┬─────────────┬─────────────┐
│  错误级别    │   服务代码   │  具体错误码  │
│  (1位)      │   (3位)     │   (3位)     │
└─────────────┴─────────────┴─────────────┘
```

**示例：** `1100001`

| 部分 | 值 | 说明 |
|------|-----|------|
| 错误级别 | `1` | 用户端错误 |
| 服务代码 | `000` | 全局通用 |
| 具体错误码 | `001` | 具体错误编号 |

### 2.2 错误级别（第1位）

| 级别代码 | 级别名称 | 说明 | 是否告警 |
|----------|----------|------|----------|
| `1` | 用户端错误 | 参数校验、权限不足、业务规则校验失败等 | 否 |
| `2` | 服务端错误 | 系统异常、数据库错误、业务逻辑异常等 | 是 |
| `3` | 第三方服务错误 | 支付、短信、OSS等第三方服务调用失败 | 是 |

### 2.3 服务代码（第2-4位）

| 服务代码 | 服务名称 | 说明 |
|----------|----------|------|
| `000` | 全局通用 | 不特定于某个微服务的通用错误码 |
| `001` | 核心公共模块 | 统一返回对象、全局配置等 |
| `002` | 网关服务 | 统一入口、路由转发 |
| `100` | IAM认证授权服务 | 认证授权、用户登录、权限管理 |
| `200` | 系统管理服务 | 用户、角色、部门、菜单管理 |
| `300-899` | 业务服务预留 | 根据实际业务需求分配 |
| `900` | 微信服务 | 微信登录、微信支付 |
| `901` | 支付宝服务 | 支付宝登录、支付宝支付 |
| `902` | 短信服务 | 验证码、通知短信 |
| `903` | OSS存储服务 | 文件上传、下载 |

### 2.4 具体错误码（第5-7位）

| 范围 | 说明 |
|------|------|
| `000-099` | 通用错误（参数、权限等） |
| `100-199` | 用户相关错误 |
| `200-299` | 部门相关错误 |
| `300-399` | 角色相关错误 |
| `400-499` | 菜单相关错误 |
| `500-999` | 其他业务错误 |

## 3. 错误码分类

### 3.1 全局通用错误（1xx0000）

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| `1000000` | 操作成功 | 成功响应 |
| `1000001` | 请求参数错误 | 参数格式或类型错误 |
| `1000002` | 参数校验失败 | `@Valid` 校验失败 |
| `1000003` | 不支持的操作 | 不允许执行此操作 |
| `1000100` | 未授权，请先登录 | 未登录 |
| `1000101` | Token 无效 | Token 解析失败 |
| `1000102` | Token 已过期 | Token 超期 |
| `1000103` | Token 缺失 | 请求头未携带 Token |
| `1000104` | 无权限访问 | 权限不足 |
| `1000105` | 权限不足 | 权限不足 |
| `2000000` | 系统内部错误 | 未知系统异常 |
| `2000001` | 系统繁忙，请稍后再试 | 系统负载过高 |
| `2000002` | 服务暂时不可用 | 服务下线或熔断 |
| `2000003` | 数据库操作失败 | 数据库异常 |
| `2000004` | 缓存操作失败 | 缓存异常 |

### 3.2 IAM 服务错误（11xx00x）

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| `1100001` | 用户不存在 | 用户ID查询无结果 |
| `1100002` | 用户名或密码错误 | 登录失败 |
| `1100003` | 用户已被禁用 | 用户状态为禁用 |
| `1100004` | 用户名已存在 | 注册时用户名重复 |
| `1100005` | 验证码已过期 | 验证码超时 |
| `1100006` | 验证码错误 | 验证码不匹配 |
| `1100007` | 验证码已发送，请勿重复获取 | 短信验证码限制 |
| `1100008` | 原密码错误 | 修改密码时原密码错误 |
| `1100009` | 新密码不能与原密码相同 | 修改密码校验 |

### 3.3 系统管理服务错误（12xx00x）

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| `1200001` | 数据不存在 | 通用数据不存在 |
| `1200002` | 数据已存在 | 通用数据重复 |
| `1200101` | 部门下存在用户，无法删除 | 删除部门校验 |
| `1200102` | 部门下存在子部门，无法删除 | 删除部门校验 |
| `1200201` | 角色下存在用户，无法删除 | 删除角色校验 |
| `1200202` | 角色已分配菜单权限，无法删除 | 删除角色校验 |
| `1200301` | 菜单下存在子菜单，无法删除 | 删除菜单校验 |

### 3.4 第三方服务错误（39xx00x）

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| `3000000` | 第三方服务调用失败 | 通用第三方错误 |
| `3000001` | 第三方服务超时 | 调用超时 |
| `3900001` | 微信登录失败 | 微信 OAuth 失败 |
| `3900002` | 微信支付失败 | 微信支付失败 |
| `3902001` | 短信发送失败 | 短信服务异常 |
| `3902002` | 短信发送频率过高 | 短信限流 |
| `3903001` | 文件上传失败 | OSS 上传失败 |
| `3903002` | 文件下载失败 | OSS 下载失败 |
| `3903003` | 文件大小超出限制 | 文件大小超限 |
| `3903004` | 文件类型不支持 | 文件类型不允许 |

## 4. 统一响应体

所有接口返回统一的 JSON 格式：

```json
{
  "success": false,
  "code": 1100001,
  "message": "用户不存在",
  "data": null,
  "timestamp": 1705912345678,
  "traceId": "abc123def456"
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | Boolean | 操作是否成功（code=1000000 时为 true） |
| `code` | Integer | 业务错误码（7位） |
| `message` | String | 错误提示信息 |
| `data` | Object | 返回数据（成功时有值） |
| `timestamp` | Long | 响应时间戳 |
| `traceId` | String | 链路追踪ID |

## 5. 使用规范

### 5.1 抛出业务异常

```java
// 使用预定义错误码
if (user == null) {
    throw new BusinessException(BusinessErrorCode.USER_NOT_FOUND);
}

// 自定义错误消息
if (stock < quantity) {
    throw new BusinessException(BusinessErrorCode.STOCK_NOT_ENOUGH,
        "库存不足，当前库存：" + stock);
}
```

### 5.2 返回失败结果

```java
// 使用错误码枚举
return R.fail(BusinessErrorCode.USER_DISABLED);

// 自定义消息
return R.fail(BusinessErrorCode.PARAM_VALIDATION_ERROR, "用户名不能为空");
```

### 5.3 定义新错误码

```java
// 在 BusinessErrorCode 中添加
@Getter
@AllArgsConstructor
public enum BusinessErrorCode implements ErrorCode {
    // 新增错误码
    ORDER_NOT_FOUND(1300001, "订单不存在"),
    ORDER_STATUS_ERROR(1300002, "订单状态错误"),
    // ...
}
```

## 6. 命名约定

### 6.1 错误码枚举命名

- 使用大写字母和下划线
- 格式：`{模块}_{具体错误}`
- 示例：`USER_NOT_FOUND`、`ORDER_STATUS_ERROR`

### 6.2 错误信息编写

- 对用户友好，避免技术术语
- 避免暴露敏感信息（SQL、堆栈等）
- 清晰说明问题原因
- 示例：✅"用户不存在" ❌"SELECT * FROM user WHERE id = ? 返回空"

## 7. 最佳实践

1. **唯一性**：错误码在全局范围内唯一
2. **可维护性**：优先使用枚举定义，避免硬编码
3. **告警策略**：服务端错误（2xx）和第三方错误（3xx）需要告警
4. **日志记录**：全局异常处理器统一记录日志
5. **国际化**：message 支持国际化（未来扩展）
